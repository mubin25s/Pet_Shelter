<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Pets - Paws Shelter</title>
    <link rel="stylesheet" href="css/petshelder.css">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">üêæ Paws Admin</div>
                <div class="nav-links">
                    <a href="admin_dashboard.html">Dashboard</a>
                    <a href="admin_adoptions.html">Adoptions</a>
                    <a href="#" onclick="logout()">Logout</a>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1>Manage Pets</h1>
            <button onclick="openAddModal()" class="btn btn-primary">‚ûï Add New Pet</button>
        </div>
        
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>ID</th><th>Image</th><th>Name</th><th>Type</th><th>Status</th><th>Health</th><th>Action</th>
                    </tr>
                </thead>
                <tbody id="pet-table"></tbody>
            </table>
        </div>
    </div>

    <!-- Add Pet Modal -->
    <div id="add-pet-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:380px; text-align:left; padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 class="modal-title" style="margin:0; font-size:1.3rem;">Add New Pet üêæ</h3>
                <button onclick="closeAddModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">√ó</button>
            </div>
            
            <form id="add-pet-form" onsubmit="submitNewPet(event)">
                <div class="form-group" style="margin-bottom:8px;">
                    <label style="font-size:0.85rem;">Pet Name</label>
                    <input type="text" name="name" required placeholder="e.g. Luna" style="padding:6px; font-size:0.9rem;">
                </div>
                <div class="form-group" style="margin-bottom:8px;">
                    <label style="font-size:0.85rem;">Type</label>
                    <input type="text" name="type" required placeholder="e.g. Cat, Dog" style="padding:6px; font-size:0.9rem;">
                </div>
                 <div style="display:flex; gap:10px;">
                     <div class="form-group" style="margin-bottom:8px; flex:1;">
                        <label style="font-size:0.85rem;">Health Status</label>
                        <select name="health_status" style="padding:6px; font-size:0.9rem;">
                            <option value="green">Healthy (Green)</option>
                            <option value="yellow">Needs Help (Yellow)</option>
                            <option value="red">Critical (Red)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:8px; flex:1;">
                        <label style="font-size:0.85rem;">Vaccinated</label>
                        <select name="vaccine_status" style="padding:6px; font-size:0.9rem;">
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                </div>
                <!-- Hidden defaults -->
                <input type="hidden" name="history" value="New rescue">
                <input type="hidden" name="food_habit" value="Standard">
                
                <div class="form-group" style="margin-bottom:8px;">
                    <label style="font-size:0.85rem;">Description</label>
                    <textarea name="description" required placeholder="Describe the pet..." style="height:60px; padding:6px; font-size:0.9rem;"></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom:15px;">
                    <label style="font-size:0.85rem;">Upload Photo</label>
                    <input type="file" name="image" accept="image/*" required style="font-size:0.8rem;">
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%; padding:10px; font-size:0.9rem;">Add Pet</button>
            </form>
        </div>
    </div>

    <!-- Edit Pet Modal -->
    <div id="edit-pet-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:380px; text-align:left; padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 class="modal-title" style="margin:0; font-size:1.3rem;">Edit Pet ‚úèÔ∏è</h3>
                <button onclick="closeEditModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">√ó</button>
            </div>
            
            <form id="edit-pet-form" onsubmit="submitEditPet(event)">
                <input type="hidden" name="id" id="edit-id">
                
                <div class="form-group" style="margin-bottom:8px;">
                    <label style="font-size:0.85rem;">Pet Name</label>
                    <input type="text" name="name" id="edit-name" required style="padding:6px; font-size:0.9rem;">
                </div>
                <div class="form-group" style="margin-bottom:8px;">
                    <label style="font-size:0.85rem;">Type</label>
                    <input type="text" name="type" id="edit-type" required style="padding:6px; font-size:0.9rem;">
                </div>
                 <div style="display:flex; gap:10px;">
                     <div class="form-group" style="margin-bottom:8px; flex:1;">
                        <label style="font-size:0.85rem;">Health Status</label>
                        <select name="health_status" id="edit-health" style="padding:6px; font-size:0.9rem;">
                            <option value="green">Healthy (Green)</option>
                            <option value="yellow">Needs Help (Yellow)</option>
                            <option value="red">Critical (Red)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:8px; flex:1;">
                        <label style="font-size:0.85rem;">Vaccinated</label>
                        <select name="vaccine_status" id="edit-vaccine" style="padding:6px; font-size:0.9rem;">
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom:8px;">
                    <label style="font-size:0.85rem;">Description</label>
                    <textarea name="description" id="edit-desc" required style="height:60px; padding:6px; font-size:0.9rem;"></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom:15px;">
                    <label style="font-size:0.85rem;">Change Photo (Optional)</label>
                    <input type="file" name="image" accept="image/*" style="font-size:0.8rem;">
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%; padding:10px; font-size:0.9rem;">Save Changes</button>
            </form>
        </div>
    </div>

    <script src="js/pet.js?v=supabase_v10"></script>
    <script>
        let allPets = []; // Store calls

        checkSession().then(res => { 
            if (!res.loggedIn || (res.user.role !== 'admin' && res.user.role !== 'volunteer')) window.location.href = 'login.html'; 
            window.currentUserRank = res.user.role; // Store for UI logic
        });

        async function loadPets() {
            const pets = await apiCall('pets.php');
            allPets = pets || []; // Cache for editing
            const tbody = document.getElementById('pet-table');
            tbody.innerHTML = '';
            
            if(!pets || pets.error) return;

            pets.forEach(pet => {
                // Fix image path for display
                let imgPath = pet.image;
                if (imgPath && !imgPath.startsWith('http') && !imgPath.startsWith('../')) {
                     imgPath = '../backend/' + imgPath;
                }

                let actions = ``;
                
                // Edit Button (For Admin AND Volunteer)
                actions += `<button onclick="openEditModal(${pet.id})" class="btn" style="background:#ff6b6b; color:white; padding:5px 10px; font-size:0.8rem; margin-right:5px;">Edit</button>`;

                // Delete Button (Available to all authorized staff on this page)
                actions += `<button onclick="deletePet(${pet.id})" class="btn" style="background:#c0392b; color:white; padding:5px 10px; font-size:0.8rem;">Delete</button>`;

                tbody.innerHTML += `
                <tr>
                    <td>${pet.id}</td>
                    <td><img src="${imgPath}" style="width:50px; height:50px; object-fit:cover; border-radius:50%;"></td>
                    <td>${pet.name}</td>
                    <td>${pet.type}</td>
                    <td>${pet.status}</td>
                    <td><span class="status-badge status-${pet.health_status}">${pet.health_status}</span></td>
                    <td>${actions}</td>
                </tr>`;
            });
        }
        
        async function deletePet(id) {
            showConfirmModal('Delete Pet', 'Are you sure you want to delete this pet?', async () => {
                await apiCall('pets.php?id=' + id, 'DELETE');
                loadPets();
            }, 'Delete', 'Cancel');
        }

        // Add Modal Logic
        function openAddModal() { document.getElementById('add-pet-modal').classList.add('active'); }
        function closeAddModal() { document.getElementById('add-pet-modal').classList.remove('active'); }

        async function submitNewPet(e) {
            e.preventDefault();
            const form = document.getElementById('add-pet-form');
            const formData = new FormData(form);

            const res = await apiCall('pets.php', 'POST', formData);
            if (res.success) {
                closeAddModal();
                form.reset();
                showWarmModal('Success', 'New pet added successfully! üêæ', 'üéâ');
                loadPets();
            } else {
                showWarmModal('Error', 'Failed to add pet: ' + res.error, '‚ùå');
            }
        }
        
        // Edit Modal Logic
        function openEditModal(id) {
            const pet = allPets.find(p => p.id == id);
            if (!pet) return;
            
            document.getElementById('edit-id').value = pet.id;
            document.getElementById('edit-name').value = pet.name;
            document.getElementById('edit-type').value = pet.type;
            document.getElementById('edit-health').value = pet.health_status;
            document.getElementById('edit-vaccine').value = pet.vaccine_status;
            document.getElementById('edit-desc').value = pet.description;
            
            document.getElementById('edit-pet-modal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('edit-pet-modal').classList.remove('active');
        }

        async function submitEditPet(e) {
            e.preventDefault();
            const form = document.getElementById('edit-pet-form');
            const formData = new FormData(form);

            // Use update query param for backend switch
            const res = await apiCall('pets.php?action=update', 'POST', formData);
            if (res.success) {
                closeEditModal();
                showWarmModal('Success', 'Pet details updated! üìù', '‚úÖ');
                loadPets();
            } else {
                showWarmModal('Error', 'Update failed: ' + res.error, '‚ùå');
            }
        }

        loadPets();
    </script>
</body>
</html>
